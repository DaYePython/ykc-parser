# 云快充协议报文结构

## 应用层报文格式

| 字段 | 长度 | 说明 |
|------|------|------|
| 起始标志 | 1字节 | 固定为 0x68 |
| 数据长度 | 1字节 | 序列号+加密标志+帧类型+消息体的总长度 |
| 序列号域 | 2字节 | 数据包发送顺序号(小端序) |
| 加密标志 | 1字节 | 0x00不加密, 0x01加密 |
| 帧类型标志 | 1字节 | 定义数据帧类型 |
| 消息体 | N字节 | 根据帧类型不同而不同,最大200字节 |
| 帧校验域 | 2字节 | CRC16校验(小端序) |

## 报文解析流程

### 1. 基本结构校验
```
检查起始标志 == 0x68
检查数据长度是否合理 (5-205)
检查报文总长度 = 1 + 1 + 数据长度 + 2
```

### 2. CRC16校验
```
校验范围: 序列号域到消息体结束
校验算法: Modbus CRC16 (多项式0x180D)
字节序: 低字节在前,高字节在后
注意: 即使校验失败也继续解析
```

### 3. 提取报文字段
```
起始标志: offset=0, len=1
数据长度: offset=1, len=1
序列号: offset=2, len=2 (小端BIN)
加密标志: offset=4, len=1
帧类型: offset=5, len=1
消息体: offset=6, len=(数据长度-4)
CRC16: offset=(6+消息体长度), len=2 (小端)
```

### 4. 消息体解析
根据帧类型,按照对应的字段定义解析消息体

## 示例报文

### 登录认证 (0x01)
```
原始报文:
68 22 0000 00 01 55031412782305 00 02 0F 56342E312E353000 01 01010101010101010101 04 675A

解析:
起始标志: 0x68
数据长度: 0x22 (34字节)
序列号: 0x0000 (0)
加密标志: 0x00 (不加密)
帧类型: 0x01 (登录认证)
消息体 (28字节):
  - 桩编码(BCD 7字节): 55031412782305
  - 桩类型(BIN 1字节): 0x00 (直流桩)
  - 充电枪数量(BIN 1字节): 0x02 (2枪)
  - 通信协议版本(BIN 1字节): 0x0F (v1.5)
  - 程序版本(ASCII 8字节): "v4.1.50\0"
  - 网络链接类型(BIN 1字节): 0x01 (LAN)
  - SIM卡(BCD 10字节): 01010101010101010101
  - 运营商(BIN 1字节): 0x04 (其他)
CRC16: 0x675A
```

### 实时数据 (0x13)
```
原始报文:
68 40 1A03 00 13 00000000000000000000000000000 55031412782305 01 00 01 01 0200 0000 00 000000000000000 00 00 0000 0000 00000000 00000000 00000000 0000 9DAC

解析:
起始标志: 0x68
数据长度: 0x40 (64字节)
序列号: 0x031A (794小端序)
加密标志: 0x00
帧类型: 0x13 (实时数据)
消息体 (58字节):
  - 交易流水号(BCD 16字节): 全0
  - 桩编码(BCD 7字节): 55031412782305
  - 枪号(BCD 1字节): 0x01 (1号枪)
  - 状态(BIN 1字节): 0x00 (离线)
  - 枪是否归位(BIN 1字节): 0x01 (是)
  - 是否插枪(BIN 1字节): 0x01 (是)
  - 输出电压(BIN 2字节): 0x0002 → 0.2V
  - 输出电流(BIN 2字节): 0x0000 → 0.0A
  - 枪线温度(BIN 1字节): 0x00 → -50℃
  - 枪线编码(BIN 8字节): 全0
  - SOC(BIN 1字节): 0x00 → 0%
  - 电池温度(BIN 1字节): 0x00 → -50℃
  - 累计时间(BIN 2字节): 0x0000 → 0分钟
  - 剩余时间(BIN 2字节): 0x0000 → 0分钟
  - 充电度数(BIN 4字节): 0x00000000 → 0.0000度
  - 计损度数(BIN 4字节): 0x00000000 → 0.0000度
  - 已充金额(BIN 4字节): 0x00000000 → 0.0000元
  - 硬件故障(BIN 2字节): 0x0000 (无故障)
CRC16: 0x9DAC
```

## 常见错误处理

### 1. 报文长度不对
```
错误: 实际报文长度 != (数据长度 + 4)
原因: 数据截断、传输错误
处理: 返回错误信息,标注实际长度和期望长度
```

### 2. 数据类型长度不符
```
错误: 消息体长度不足以解析所有字段
原因: 报文不完整、协议版本不匹配
处理: 尽可能解析已有字段,标注缺失字段
```

### 3. 数据类型不符
```
错误: ASCII码字段包含非ASCII字符
原因: 数据错误、编码问题
处理: 标注错误位置和实际值
```

### 4. CRC校验失败
```
错误: 计算的CRC != 报文中的CRC
原因: 数据传输错误、CRC计算错误
处理: 标注CRC错误,但继续解析报文内容
```

### 5. 未知帧类型
```
错误: 帧类型码不在0x01-0xA4定义范围内
原因: 协议更新、数据错误
处理: 返回帧类型,但不解析消息体
```

## 错误返回格式

```json
{
  "code": 500,
  "msg": "具体错误信息",
  "errors": [
    "CRC16校验失败: 期望0x675A, 实际0x675B",
    "报文长度不对: 期望38字节, 实际36字节",
    "ASCII字段包含非ASCII字符: offset=19, value=0xFF"
  ],
  "partial_data": {
    "frame_type": "0x01",
    "frame_type_name": "登录认证"
  }
}
```
