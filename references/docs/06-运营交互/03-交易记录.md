# 交易记录

## 8.7 交易记录 (0x3B)

### 基本信息

| 项目 | 说明 |
|------|------|
| 帧类型码 | 0x3B |
| 传送间隔 | 主动上送 |
| 数据方向 | 充电桩→运营平台 |

### 功能说明

充电桩在网络正常情况下,主动发送结算账单,直到运营平台响应成账单上传成功(若未收到0x40回复间隔30s再重试一次,最多重试3次),收到账单结算成功,本账单在充电桩本地删除。

**重要:** 每次接收到启机命令并已执行启机过程,无论启机成功与否,都需在订单结束充电后生成账单上传

### 样例报文

```
68(起始标志)A2(数据长度)8001(序列号域)00(加密标志)3B(类型)
55031412782305012018061910262392(交易流水号)
55031412782305(桩编码)
01(枪号:1枪)
98B70E11100314(开始时间:2020-03-16 17:14:47)
98B70E11100314(结束时间:2020-03-16 17:14:47)
D0FB0100(尖单价:1.30000)
00000000(尖电量:0)
00000000(计损尖电量:0)
00000000(尖金额:0)
D0FB0100(峰单价:1.30000)
00000000(峰电量:0)
00000000(计损峰电量:0)
00000000(峰金额:0)
D0FB0100(平单价:1.30000)
00000000(平电量:0)
00000000(计损平电量:0)
00000000(平金额:0)
D0FB0100(谷单价:1.30000)
00000000(谷电量:0)
00000000(计损谷电量:0)
00000000(谷金额:0)
00000000(电表总起值:0)
00000000(电表总止值:0)
00000000(总电量:0)
00000000(计损总电量:0)
00000000(消费金额:0)
00000000000000000000000000000000(VIN码)
01(交易标识)
98B70E11100314(交易日期时间)
00(停止原因)
00000000D14B0A54(物理卡号)
```

### 数据定义

| 序号 | 参数名称 | 数据类型 | 长度(Byte) | 备注 |
|------|----------|----------|------------|------|
| 1 | 交易流水号 | BCD码 | 16 | 见名词解释 |
| 2 | 桩编号 | BCD码 | 7 | 不足7位补0 |
| 3 | 枪号 | BCD码 | 1 | |
| 4 | 开始时间 | BIN | 7 | CP56Time2a格式 |
| 5 | 结束时间 | BIN | 7 | CP56Time2a格式 |
| 6 | 尖单价 | BIN | 4 | 精确到小数点后五位(尖电费+尖服务费,见费率帧) |
| 7 | 尖电量 | BIN | 4 | 精确到小数点后四位 |
| 8 | 计损尖电量 | BIN | 4 | 精确到小数点后四位 |
| 9 | 尖金额 | BIN | 4 | 精确到小数点后四位 |
| 10 | 峰单价 | BIN | 4 | 精确到小数点后五位(峰电费+峰服务费) |
| 11 | 峰电量 | BIN | 4 | 精确到小数点后四位 |
| 12 | 计损峰电量 | BIN | 4 | 精确到小数点后四位 |
| 13 | 峰金额 | BIN | 4 | 精确到小数点后四位 |
| 14 | 平单价 | BIN | 4 | 精确到小数点后五位(平电费+平服务费) |
| 15 | 平电量 | BIN | 4 | 精确到小数点后四位 |
| 16 | 计损平电量 | BIN | 4 | 精确到小数点后四位 |
| 17 | 平金额 | BIN | 4 | 精确到小数点后四位 |
| 18 | 谷单价 | BIN | 4 | 精确到小数点后五位(谷电费+谷服务费) |
| 19 | 谷电量 | BIN | 4 | 精确到小数点后四位 |
| 20 | 计损谷电量 | BIN | 4 | 精确到小数点后四位 |
| 21 | 谷金额 | BIN | 4 | 精确到小数点后四位 |
| 22 | 电表总起值 | BIN | 5 | 精确到小数点后四位 |
| 23 | 电表总止值 | BIN | 5 | 精确到小数点后四位 |
| 24 | 总电量 | BIN | 4 | 精确到小数点后四位 |
| 25 | 计损总电量 | BIN | 4 | 精确到小数点后四位 |
| 26 | 消费金额 | BIN | 4 | 精确到小数点后四位,包含电费、服务费 |
| 27 | 电动汽车唯一标识 | ASCII | 17 | VIN码,此处VIN码和充电时VIN码不同,正序直接上传,无需补0和反序 |
| 28 | 交易标识 | BIN | 1 | 0x01:app启动<br>0x02:卡启动<br>0x04:离线卡启动<br>0x05:vin码启动充电 |
| 29 | 交易日期、时间 | BIN | 7 | CP56Time2a格式 |
| 30 | 停止原因 | BIN | 1 | 见附录11.1 |
| 31 | 物理卡号 | BIN码 | 8 | 不足8位补0 |

---

## 8.8 交易记录确认 (0x40)

### 基本信息

| 项目 | 说明 |
|------|------|
| 帧类型码 | 0x40 |
| 传送间隔 | 应答发送 |
| 数据方向 | 运营平台→充电桩 |

### 功能说明

运营平台接收到结算账单上传后,都需回复此确认信息。

**重要:**
- 若桩未收到回复帧,则5分钟后继续上送一次交易记录,此情况下无论平台是否成功回复都停止上送
- 这一帧仅是报文交互使用,意指平台成功接收到交易记录报文,并不代表交易订单成功结算

### 样例报文

```
68(起始标志)15(数据长度)0002(序列号域)00(加密标志)40(类型)
55031412782305012018061910262392(交易流水号)
00(确认结果)
48B1(帧校验域)
```

### 数据定义

| 序号 | 参数名称 | 数据类型 | 长度(Byte) | 备注 |
|------|----------|----------|------------|------|
| 1 | 交易流水号 | BCD码 | 16 | |
| 2 | 确认结果 | BIN码 | 1 | 0x00:上传成功<br>0x01:非法账单 |
