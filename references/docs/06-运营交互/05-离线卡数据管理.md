# 离线卡数据管理

离线卡适用于桩离线充电模式,平台在充电桩在线时会下发此数据帧到充电桩,充电桩接收到后储存离线卡信息到桩本地,若用户刷卡充电时桩处于离线模式,则鉴权走桩本地进行判断。

---

## 8.11 离线卡数据同步 (0x44)

### 基本信息

| 项目 | 说明 |
|------|------|
| 帧类型码 | 0x44 |
| 传送间隔 | 按需下发 |
| 数据方向 | 运营平台→充电桩 |

### 功能说明

平台在充电桩在线时会下发此数据帧到充电桩,充电桩接收到后储存离线卡信息到桩本地。

**处理规则:**
- 如果已存在离线卡,则用最新的数据覆盖本地数据
- 不存在则插入新的离线卡数据

### 样例报文

```
68(起始标志)2C(数据长度)0007(序列号域)00(加密标志)44(类型)
32010200000001(桩编码)
01(下发卡个数)
00000001000000573(逻辑卡号)
00000000D14B0A54(物理卡号:D14B0A54)
F264(帧校验域)
```

### 数据定义

| 序号 | 参数名称 | 数据类型 | 长度(Byte) | 备注 |
|------|----------|----------|------------|------|
| 1 | 桩编号 | BCD码 | 7 | |
| 2 | 下发卡个数 | BIN码 | 1 | 最大15个 |
| 3 | 第1个卡逻辑卡号 | BCD码 | 8 | 离线卡逻辑卡号 |
| 4 | 第1个卡物理卡号 | BIN码 | 8 | 离线卡物理卡号 |
| ...... | ...... | ...... | ...... | |
| N×2+1 | 第N个卡逻辑卡号 | BCD码 | 8 | 离线卡逻辑卡号 |
| N×2+2 | 第N个卡物理卡号 | BIN码 | 8 | 离线卡物理卡号 |

---

## 8.12 离线卡数据同步应答 (0x43)

### 基本信息

| 项目 | 说明 |
|------|------|
| 帧类型码 | 0x43 |
| 传送间隔 | 应答 |
| 数据方向 | 充电桩→运营平台 |

### 功能说明

充电桩接收离线卡数据同步指令后的应答。

### 样例报文

```
68(起始标志)0D(数据长度)0007(序列号域)00(加密标志)43(类型)
32010200000001(桩编码)
01(保存结果)
00(失败原因)
6890(帧校验域)
```

### 数据定义

| 序号 | 参数名称 | 数据类型 | 长度(Byte) | 备注 |
|------|----------|----------|------------|------|
| 1 | 桩编号 | BCD码 | 7 | |
| 2 | 保存结果 | BIN码 | 1 | 0x00:失败<br>0x01:成功 |
| 3 | 失败原因 | BIN码 | 1 | 0x01:卡号格式错误<br>0x02:储存空间不足 |

---

## 8.13 离线卡数据清除 (0x46)

### 基本信息

| 项目 | 说明 |
|------|------|
| 帧类型码 | 0x46 |
| 传送间隔 | 按需下发 |
| 数据方向 | 运营平台→充电桩 |

### 功能说明

离线卡清除是平台主动下发的操作,平台在充电桩在线时会下发此数据帧到充电桩,充电桩接收到离线卡数据清除报文后清除桩本地对应的离线卡数据。

### 样例报文

```
68(起始标志)2C(数据长度)0007(序列号域)00(加密标志)46(类型)
32010200000001(桩编码)
01(清除离线卡的个数)
00000000D14B0A54(物理卡号:D14B0A54)
F264(帧校验域)
```

### 数据定义

| 序号 | 参数名称 | 数据类型 | 长度(Byte) | 备注 |
|------|----------|----------|------------|------|
| 1 | 桩编号 | BCD码 | 7 | |
| 2 | 清除离线卡的个数 | BIN码 | 1 | 最大24个 |
| 3 | 第1个卡物理卡号 | BIN码 | 8 | 离线卡物理卡号 |
| ...... | ...... | ...... | ...... | |
| N+2 | 第N个卡物理卡号 | BIN码 | 8 | 离线卡物理卡号 |

---

## 8.14 离线卡数据清除应答 (0x45)

### 基本信息

| 项目 | 说明 |
|------|------|
| 帧类型码 | 0x45 |
| 传送间隔 | 应答 |
| 数据方向 | 充电桩→运营平台 |

### 功能说明

充电桩接收离线卡数据清除指令后的应答,针对每个卡号返回清除结果。

### 样例报文

```
68(起始标志)0D(数据长度)0007(序列号域)00(加密标志)45(类型)
32010200000001(桩编码)
00000000D14B0A54(物理卡号:D14B0A54)
01(清除标记)
00(失败原因)
00000000E14C0A54(物理卡号:E14C0A54)
00(清除标记)
01(失败原因)
6890(帧校验域)
```

### 数据定义

| 序号 | 参数名称 | 数据类型 | 长度(Byte) | 备注 |
|------|----------|----------|------------|------|
| 1 | 桩编号 | BCD码 | 7 | |
| 2 | 第1个卡物理卡号 | BIN码 | 8 | 离线卡物理卡号 |
| 3 | 清除标记 | BIN码 | 1 | 0x00:清除失败<br>0x01:清除成功 |
| 4 | 失败原因 | BCD码 | 1 | 0x00:清除成功<br>0x01:卡号格式错误 |
| ...... | ...... | ...... | ...... | |
| N×3-1 | 第N个卡物理卡号 | BIN码 | 8 | 离线卡物理卡号 |
| N×3 | 清除标记 | BIN码 | 1 | 0x00:清除失败<br>0x01:清除成功 |
| N×3+1 | 失败原因 | BCD码 | 1 | 0x00:清除成功<br>0x01:卡号格式错误 |

---

## 8.15 离线卡数据查询 (0x48)

### 基本信息

| 项目 | 说明 |
|------|------|
| 帧类型码 | 0x48 |
| 传送间隔 | 按需下发 |
| 数据方向 | 运营平台→充电桩 |

### 功能说明

离线卡数据查询由平台主动向桩发起的查询请求,平台在充电桩在线时会按需下发此数据帧到充电桩,桩接收到该报文后进行查询桩本地是否存在对应的离线卡。

### 样例报文

```
68(起始标志)2C(数据长度)0007(序列号域)00(加密标志)48(类型)
32010200000001(桩编码)
01(查询的离线卡个数)
00000000D14B0A54(物理卡号:D14B0A54)
F264(帧校验域)
```

### 数据定义

| 序号 | 参数名称 | 数据类型 | 长度(Byte) | 备注 |
|------|----------|----------|------------|------|
| 1 | 桩编号 | BCD码 | 7 | |
| 2 | 查询的离线卡个数 | BIN码 | 1 | 最大26个 |
| 3 | 第1个卡物理卡号 | BIN码 | 8 | 离线卡物理卡号 |
| ...... | ...... | ...... | ...... | |
| N+2 | 第N个卡物理卡号 | BIN码 | 8 | 离线卡物理卡号 |

---

## 8.16 离线卡数据查询应答 (0x47)

### 基本信息

| 项目 | 说明 |
|------|------|
| 帧类型码 | 0x47 |
| 传送间隔 | 应答 |
| 数据方向 | 充电桩→运营平台 |

### 功能说明

充电桩接收离线卡数据查询指令后的应答,针对每个卡号返回是否存在。

### 样例报文

```
68(起始标志)0D(数据长度)0007(序列号域)00(加密标志)47(类型)
32010200000001(桩编码)
00000000D14B0A54(物理卡号:D14B0A54)
01(查询结果)
00000000E14C0A54(物理卡号:E14C0A54)
00(查询结果)
6890(帧校验域)
```

### 数据定义

| 序号 | 参数名称 | 数据类型 | 长度(Byte) | 备注 |
|------|----------|----------|------------|------|
| 1 | 桩编号 | BCD码 | 7 | |
| 2 | 第1个卡物理卡号 | BIN码 | 8 | 离线卡物理卡号 |
| 3 | 查询结果 | BIN码 | 1 | 0x00:不存在<br>0x01:存在 |
| ...... | ...... | ...... | ...... | |
| N×2 | 第N个卡物理卡号 | BIN码 | 8 | 离线卡物理卡号 |
| N×2+1 | 查询结果 | BIN码 | 1 | 0x00:不存在<br>0x01:存在 |
