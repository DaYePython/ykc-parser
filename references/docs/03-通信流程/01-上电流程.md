# 上电流程

## 流程说明

充电桩在上电或者离线恢复后连接到云快充平台,首先上送充电桩登陆认证,平台对桩的信息进行校验,并回复登陆认证应答,如果不符合则会断开当前建立的连接,如果验证通过,则桩先检查是否有离线状态下本地储存的实时监测数据或者交易数据,如果有则先上送到平台进行处理,随后充电桩发起充电计费模型的请求,平台检测计费模型与当前运营费率是否一致,并回复计费模型请求应答,如果不一致,桩需要向平台请求新的计费模型。

## 流程图

```mermaid
sequenceDiagram
    participant 充电桩
    participant 云快充平台

    充电桩->>云快充平台: 登录认证(0x01)
    云快充平台->>充电桩: 登录认证应答(0x02)

    alt 验证失败
        云快充平台->>充电桩: 断开连接
    else 验证成功
        Note over 充电桩: 检查是否有离线数据
        alt 有离线数据
            充电桩->>云快充平台: 上送离线实时数据/交易数据
        end

        充电桩->>云快充平台: 计费模型验证请求(0x05)
        云快充平台->>充电桩: 计费模型验证应答(0x06)

        alt 计费模型不一致
            充电桩->>云快充平台: 计费模型请求(0x09)
            云快充平台->>充电桩: 计费模型应答(0x0A)
        end

        充电桩->>云快充平台: 心跳包(0x03)
        云快充平台->>充电桩: 心跳包应答(0x04)
    end
```

## 关键步骤

1. **登录认证**: 充电桩上送登录认证(0x01),平台校验并应答(0x02)
2. **离线数据处理**: 如有离线数据,先上送到平台
3. **计费模型验证**: 验证计费模型是否一致(0x05/0x06)
4. **计费模型更新**: 如不一致,请求新的计费模型(0x09/0x0A)
5. **心跳保活**: 开始发送心跳包维持连接(0x03/0x04)
