# 刷卡充电流程

## 流程图

```mermaid
sequenceDiagram
    participant 用户
    participant 充电桩
    participant 云快充平台
    participant 车辆

    用户->>充电桩: 刷卡启动
    充电桩->>云快充平台: 申请启动充电(0x31)
    Note over 充电桩,云快充平台: 上送物理卡号

    云快充平台->>充电桩: 确认启动充电(0x32)
    Note over 充电桩,云快充平台: 返回鉴权结果、流水号、账户余额

    alt 鉴权失败
        充电桩->>用户: 显示失败原因
    else 鉴权成功
        充电桩->>车辆: 插枪连接
        充电桩->>云快充平台: 充电握手(0x15)
        充电桩->>云快充平台: 参数配置(0x17)

        充电桩->>车辆: 开始充电

        loop 充电过程
            充电桩->>云快充平台: 实时监测数据(0x13)
            Note over 充电桩,云快充平台: 周期15秒
        end

        alt 刷卡停止
            用户->>充电桩: 刷卡停止
            Note over 充电桩: 验证卡号
        else APP停止
            云快充平台->>充电桩: 远程停机(0x36)
            充电桩->>云快充平台: 停机命令回复(0x35)
        end

        充电桩->>车辆: 停止充电
        充电桩->>云快充平台: 充电结束(0x19)
        充电桩->>云快充平台: 交易记录(0x3B)
        云快充平台->>充电桩: 交易记录确认(0x40)
    end
```

## 关键步骤

1. **刷卡启动**: 用户在充电桩上刷卡
2. **申请启动**: 充电桩上送物理卡号,申请启动充电(0x31)
3. **鉴权确认**: 平台确认启动充电(0x32),返回:
   - 鉴权结果
   - 交易流水号
   - 账户余额
   - 逻辑卡号
4. **鉴权失败**: 充电桩显示失败原因给用户
5. **鉴权成功后的流程**:
   - 插枪连接车辆
   - 充电握手(0x15)
   - 参数配置(0x17)
   - 开始充电
   - 周期上送实时数据(0x13)
6. **充电停止**:
   - 刷卡停止: 验证卡号
   - APP停止: 接收远程停机命令(0x36),回复(0x35)
7. **结束流程**:
   - 停止充电
   - 上送充电结束(0x19)
   - 上送交易记录(0x3B)
   - 接收交易记录确认(0x40)
