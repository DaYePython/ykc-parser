#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
云快充协议完整测试用例
基于 references/frame_types.md 生成所有帧类型的测试用例
"""

import sys
import json
from pathlib import Path
from typing import Dict, List, Tuple

# 添加scripts目录到路径
sys.path.insert(0, str(Path(__file__).parent / "scripts"))

# 强制使用重构版本
from parse_ykc import YKCProtocolParser as Parser
print("使用重构版本解析器 (parse_ykc_v2.py)")


class TestCaseGenerator:
    """测试用例生成器"""

    @staticmethod
    def get_all_test_cases() -> List[Tuple[str, str, str]]:
        """
        获取所有测试用例

        Returns:
            List of (category, name, hex_data) tuples
        """
        return [
            # ==================== 注册心跳类 (0x01-0x0A) ====================
            ("注册心跳类", "充电桩登录认证 (0x01)",
             "68 22 0000 00 01 "
             "55031412782305 "  # 桩编码 7字节
             "00 "  # 桩类型
             "02 "  # 枪数量
             "0F "  # 协议版本
             "56342E312E353000 "  # 程序版本 8字节
             "01 "  # 网络类型
             "01010101010101010101 "  # SIM卡 10字节
             "04 "  # 运营商
             "0000"),  # CRC (测试用临时值)

            ("注册心跳类", "登录认证应答 (0x02)",
             "68 0C 0001 00 02 "
             "55031412782305 "  # 桩编码
             "00 "  # 登录结果
             "0000"),  # CRC

            ("注册心跳类", "充电桩心跳包 (0x03)",
             "68 0B 0002 00 03 "
             "55031412782305 "  # 桩编码
             "0000"),  # CRC

            ("注册心跳类", "心跳包应答 (0x04)",
             "68 0B 0003 00 04 "
             "55031412782305 "  # 桩编码
             "0000"),  # CRC

            # ==================== 实时数据类 (0x12-0x25) ====================
            ("实时数据类", "读取实时监测数据 (0x12)",
             "68 0C 0010 00 12 "
             "55031412782305 "  # 桩编码
             "01 "  # 枪号
             "0000"),  # CRC

            ("实时数据类", "上传实时监测数据 (0x13)",
             "68 46 1A03 00 13 "
             "55031412782305012018061910262392 "  # 交易流水号 16字节
             "55031412782305 "  # 桩编码 7字节
             "01 "  # 枪号
             "03 "  # 状态
             "01 "  # 枪是否归位
             "01 "  # 是否插枪
             "E803 "  # 输出电压 100.0V
             "6400 "  # 输出电流 10.0A
             "46 "  # 枪线温度 20℃
             "0000000000000000 "  # 枪线编码 8字节
             "50 "  # SOC 80%
             "46 "  # 电池最高温度 20℃
             "1E00 "  # 累计充电时间 30分钟
             "3C00 "  # 剩余时间 60分钟
             "10270000 "  # 充电度数 1.0000度
             "10270000 "  # 计损充电度数
             "10270000 "  # 已充金额 1.0000元
             "0000 "  # 硬件故障
             "0000"),  # CRC

            ("实时数据类", "充电握手 (0x15)",
             "68 4D 0015 00 15 "
             "32010200000000111511161555350026 "  # 交易流水号 16字节
             "32010200000001 "  # 桩编码 7字节
             "01 "  # 枪号
             "000000 "  # BMS通信协议版本号 3字节
             "03 "  # BMS电池类型 (磷酸铁锂)
             "0000 "  # BMS额定容量
             "0000 "  # BMS额定总电压
             "00000000 "  # BMS电池生产厂商 4字节
             "00000000 "  # BMS电池组序号 4字节
             "00 00 00 "  # BMS生产日期 年月日
             "000000 "  # BMS充电次数 3字节
             "01 "  # BMS产权标识 (车自有)
             "00 "  # 预留位
             "0000000000000000000000000000000000 "  # BMS VIN码 17字节
             "0000000000000000 "  # BMS软件版本 8字节
             "0000"),  # CRC

            ("实时数据类", "参数配置 (0x17)",
             "68 31 0016 00 17 "
             "32010200000000111511161555350026 "  # 交易流水号
             "32010200000001 "  # 桩编码
             "01 "  # 枪号
             "0000 "  # BMS单体最高电压
             "0000 "  # BMS最高充电电流
             "0000 "  # BMS标称总能量
             "0000 "  # BMS最高总电压
             "00 "  # BMS最高温度
             "0000 "  # BMS SOC
             "0000 "  # BMS当前电压
             "0000 "  # 电桩最高输出电压
             "0000 "  # 电桩最低输出电压
             "0000 "  # 电桩最大输出电流
             "0000 "  # 电桩最小输出电流
             "0000"),  # CRC

            ("实时数据类", "充电结束 (0x19)",
             "68 2B 0016 00 19 "
             "32010200000000111511161555350026 "  # 交易流水号
             "32010200000001 "  # 桩编码
             "01 "  # 枪号
             "64 "  # BMS中止SOC 100%
             "0000 "  # BMS单体最低电压
             "0000 "  # BMS单体最高电压
             "00 "  # BMS最低温度
             "00 "  # BMS最高温度
             "0000 "  # 累计充电时间
             "0000 "  # 输出能量
             "00000000 "  # 充电机编号
             "0000"),  # CRC

            ("实时数据类", "错误报文 (0x1B)",
             "68 24 0017 00 1B "
             "32010200000000111511161555350026 "  # 交易流水号
             "32010200000001 "  # 桩编码
             "01 "  # 枪号
             "00000000000000 00 "  # 错误字节 8字节
             "0000"),  # CRC

            ("实时数据类", "充电阶段BMS中止 (0x1D)",
             "68 20 0018 00 1D "
             "32010200000000111511161555350026 "  # 交易流水号
             "32010200000001 "  # 桩编码
             "01 "  # 枪号
             "00 "  # BMS中止充电原因
             "0000 "  # BMS中止充电故障原因
             "00 "  # BMS中止充电错误原因
             "0000"),  # CRC

            ("实时数据类", "充电阶段充电机中止 (0x21)",
             "68 20 0018 00 21 "
             "32010200000000111511161555350026 "  # 交易流水号
             "32010200000001 "  # 桩编码
             "01 "  # 枪号
             "00 "  # 充电机中止充电原因
             "0000 "  # 充电机中止充电故障原因
             "00 "  # 充电机中止充电错误原因
             "0000"),  # CRC

            ("实时数据类", "BMS需求/充电机输出 (0x23)",
             "68 30 0019 00 23 "
             "32010200000000111511161555350026 "  # 交易流水号
             "32010200000001 "  # 桩编码
             "01 "  # 枪号
             "0000 "  # BMS电压需求
             "0000 "  # BMS电流需求
             "01 "  # BMS充电模式
             "0000 "  # BMS充电电压测量值
             "0000 "  # BMS充电电流测量值
             "0000 "  # BMS最高单体电压及组号
             "50 "  # BMS当前SOC 80%
             "0000 "  # BMS估算剩余时间
             "0000 "  # 电桩电压输出值
             "0000 "  # 电桩电流输出值
             "0000 "  # 累计充电时间
             "0000"),  # CRC

            ("实时数据类", "BMS信息 (0x25)",
             "68 23 0021 00 25 "
             "32010200000000111511161555350026 "  # 交易流水号
             "32010200000001 "  # 桩编码
             "01 "  # 枪号
             "00 "  # BMS最高单体电压所在编号
             "46 "  # BMS最高温度 20℃
             "00 "  # 最高温度检测点编号
             "32 "  # 最低温度 0℃
             "00 "  # 最低温度检测点编号
             "0000 "  # 状态标志字节
             "0000"),  # CRC

            # ==================== 运营交互类 (0x31-0x48) ====================
            ("运营交互类", "充电桩主动申请启动 (0x31)",
             "68 1A 0020 00 31 "
             "32010200000001 "  # 桩编码
             "01 "  # 枪号
             "00000000D14B0A54 "  # 物理卡号
             "00000000 "  # 卡余额
             "00 "  # 启动方式
             "0000"),  # CRC

            ("运营交互类", "确认启动充电 (0x32)",
             "68 11 0021 00 32 "
             "32010200000001 "  # 桩编码
             "01 "  # 枪号
             "00 "  # 启动结果
             "00 "  # 充电模式
             "00000000 "  # 本次订单号
             "0000"),  # CRC

            ("运营交互类", "远程启机回复 (0x33)",
             "68 13 0022 00 33 "
             "32010200000001 "  # 桩编码
             "01 "  # 枪号
             "00 "  # 执行结果
             "00000000 "  # 订单号
             "00 "  # 失败原因
             "0000"),  # CRC

            ("运营交互类", "远程控制启机 (0x34)",
             "68 1A 0023 00 34 "
             "32010200000001 "  # 桩编码
             "01 "  # 枪号
             "00000000D14B0A54 "  # 物理卡号
             "00000000 "  # 卡余额
             "00 "  # 充电模式
             "0000"),  # CRC

            ("运营交互类", "远程停机回复 (0x35)",
             "68 12 0024 00 35 "
             "32010200000001 "  # 桩编码
             "01 "  # 枪号
             "00 "  # 执行结果
             "00000000 "  # 订单号
             "00 "  # 失败原因
             "0000"),  # CRC

            ("运营交互类", "远程停机 (0x36)",
             "68 10 0025 00 36 "
             "32010200000001 "  # 桩编码
             "01 "  # 枪号
             "00000000 "  # 订单号
             "0000"),  # CRC

            ("运营交互类", "交易记录 (0x3B)",
             "68 A2 8001 00 3B "
             "55031412782305012018061910262392 "  # 交易流水号 16字节
             "55031412782305 "  # 桩编码 7字节
             "01 "  # 枪号
             "98B70E11100314 "  # 开始时间 CP56Time2a 7字节
             "98B70E11100314 "  # 结束时间
             "D0FB0100 "  # 尖单价
             "00000000 "  # 尖电量
             "00000000 "  # 计损尖电量
             "00000000 "  # 尖金额
             "D0FB0100 "  # 峰单价
             "00000000 "  # 峰电量
             "00000000 "  # 计损峰电量
             "00000000 "  # 峰金额
             "D0FB0100 "  # 平单价
             "00000000 "  # 平电量
             "00000000 "  # 计损平电量
             "00000000 "  # 平金额
             "D0FB0100 "  # 谷单价
             "00000000 "  # 谷电量
             "00000000 "  # 计损谷电量
             "00000000 "  # 谷金额
             "0000000000 "  # 电表总起值 5字节
             "0000000000 "  # 电表总止值
             "00000000 "  # 总电量
             "00000000 "  # 计损总电量
             "00000000 "  # 消费金额
             "0000000000000000000000000000000000 "  # VIN码 17字节
             "01 "  # 交易标识
             "98B70E11100314 "  # 交易日期时间
             "00 "  # 停止原因
             "00000000D14B0A54 "  # 物理卡号 8字节
             "0000"),  # CRC

            ("运营交互类", "交易记录确认 (0x40)",
             "68 15 0002 00 40 "
             "55031412782305012018061910262392 "  # 交易流水号
             "00 "  # 确认结果
             "0000"),  # CRC

            ("运营交互类", "余额更新应答 (0x41)",
             "68 14 0006 00 41 "
             "32010200000001 "  # 桩编码 7字节
             "00000000D14B0A54 "  # 物理卡号 8字节
             "01 "  # 修改结果 1字节
             "0000"),  # CRC

            ("运营交互类", "远程账户余额更新 (0x42)",
             "68 18 0006 00 42 "
             "32010200000001 "  # 桩编码
             "01 "  # 枪号
             "00000000D14B0A54 "  # 物理卡号
             "00000000 "  # 修改后账户金额
             "0000"),  # CRC

            ("运营交互类", "离线卡数据同步应答 (0x43)",
             "68 0D 0007 00 43 "
             "32010200000001 "  # 桩编码
             "01 "  # 保存结果
             "00 "  # 失败原因
             "0000"),  # CRC

            ("运营交互类", "离线卡数据同步 (0x44)",
             "68 1C 0007 00 44 "
             "32010200000001 "  # 桩编码
             "01 "  # 下发卡个数
             "0000000100000057 "  # 逻辑卡号 8字节
             "00000000D14B0A54 "  # 物理卡号 8字节
             "0000"),  # CRC

            ("运营交互类", "离线卡数据清除应答 (0x45)",
             "68 13 0007 00 45 "
             "32010200000001 "  # 桩编码
             "00000000D14B0A54 "  # 物理卡号
             "01 "  # 清除标记
             "00 "  # 失败原因
             "0000"),  # CRC

            ("运营交互类", "离线卡数据清除 (0x46)",
             "68 14 0007 00 46 "
             "32010200000001 "  # 桩编码
             "01 "  # 清除个数
             "00000000D14B0A54 "  # 物理卡号
             "0000"),  # CRC

            ("运营交互类", "离线卡数据查询应答 (0x47)",
             "68 13 0007 00 47 "
             "32010200000001 "  # 桩编码
             "00000000D14B0A54 "  # 物理卡号
             "01 "  # 查询结果
             "0000"),  # CRC

            ("运营交互类", "离线卡数据查询 (0x48)",
             "68 14 0007 00 48 "
             "32010200000001 "  # 桩编码
             "01 "  # 查询个数
             "00000000D14B0A54 "  # 物理卡号
             "0000"),  # CRC

            # ==================== 平台设置类 (0x51-0x58) ====================
            ("平台设置类", "工作参数设置应答 (0x51)",
             "68 0C 0030 00 51 "
             "32010200000001 "  # 桩编码
             "00 "  # 设置结果
             "0000"),  # CRC

            ("平台设置类", "工作参数设置 (0x52)",
             "68 16 0031 00 52 "
             "32010200000001 "  # 桩编码 7字节
             "00 "  # 参数类型 1字节
             "00000000000000000000 "  # 参数值 10字节
             "0000"),  # CRC

            ("平台设置类", "对时设置应答 (0x55)",
             "68 0C 0032 00 55 "
             "32010200000001 "  # 桩编码
             "00 "  # 对时结果
             "0000"),  # CRC

            ("平台设置类", "对时设置 (0x56)",
             "68 12 0033 00 56 "
             "32010200000001 "  # 桩编码
             "98B70E11100314 "  # 时间 CP56Time2a
             "0000"),  # CRC

            ("平台设置类", "计费模型应答 (0x57)",
             "68 0C 0034 00 57 "
             "32010200000001 "  # 桩编码
             "00 "  # 设置结果
             "0000"),  # CRC

            ("平台设置类", "计费模型设置 (0x58)",
             "68 21 0035 00 58 "
             "32010200000001 "  # 桩编码 7字节
             "00000000000000000000000000000000000000000000 "  # 计费模型数据 22字节
             "0000"),  # CRC

            # ==================== 车位锁类 (0x61-0x63) ====================
            ("车位锁类", "地锁数据上送 (0x61)",
             "68 0D 0040 00 61 "
             "32010200000001 "  # 桩编码
             "00 "  # 地锁状态
             "00 "  # 电量
             "0000"),  # CRC

            ("车位锁类", "遥控地锁升降 (0x62)",
             "68 0C 0041 00 62 "
             "32010200000001 "  # 桩编码
             "00 "  # 控制命令
             "0000"),  # CRC

            ("车位锁类", "充电桩返回数据 (0x63)",
             "68 0C 0042 00 63 "
             "32010200000001 "  # 桩编码
             "00 "  # 执行结果
             "0000"),  # CRC

            # ==================== 远程维护类 (0x91-0x94) ====================
            ("远程维护类", "远程重启应答 (0x91)",
             "68 0C 0050 00 91 "
             "32010200000001 "  # 桩编码
             "00 "  # 重启结果
             "0000"),  # CRC

            ("远程维护类", "远程重启 (0x92)",
             "68 0B 0051 00 92 "
             "32010200000001 "  # 桩编码
             "0000"),  # CRC

            ("远程维护类", "远程更新应答 (0x93)",
             "68 0C 0052 00 93 "
             "32010200000001 "  # 桩编码
             "00 "  # 更新结果
             "0000"),  # CRC

            ("远程维护类", "远程更新 (0x94)",
             "68 15 0053 00 94 "
             "32010200000001 "  # 桩编码
             "00000000000000000000 "  # 更新参数 10字节
             "0000"),  # CRC

            # ==================== 并充模式类 (0xA1-0xA4) ====================
            ("并充模式类", "主动申请并充 (0xA1)",
             "68 0C 0060 00 A1 "
             "32010200000001 "  # 桩编码
             "00 "  # 申请类型
             "0000"),  # CRC

            ("并充模式类", "确认并充启动 (0xA2)",
             "68 0C 0061 00 A2 "
             "32010200000001 "  # 桩编码
             "00 "  # 确认结果
             "0000"),  # CRC

            ("并充模式类", "远程并充启机回复 (0xA3)",
             "68 0C 0062 00 A3 "
             "32010200000001 "  # 桩编码
             "00 "  # 执行结果
             "0000"),  # CRC

            ("并充模式类", "远程控制并充启机 (0xA4)",
             "68 0C 0063 00 A4 "
             "32010200000001 "  # 桩编码
             "00 "  # 控制命令
             "0000"),  # CRC
        ]


def run_all_tests():
    """运行所有测试用例"""

    test_cases = TestCaseGenerator.get_all_test_cases()

    print("=" * 80)
    print(f"云快充协议完整测试 - 共 {len(test_cases)} 个帧类型")
    print("=" * 80)

    parser = Parser()
    results = {
        "total": len(test_cases),
        "passed": 0,
        "failed": 0,
        "by_category": {}
    }

    current_category = None

    for category, name, hex_data in test_cases:
        # 打印类别标题
        if category != current_category:
            print(f"\n{'='*80}")
            print(f"{category}")
            print(f"{'='*80}")
            current_category = category
            results["by_category"][category] = {"passed": 0, "failed": 0}

        # 解析报文
        try:
            result = parser.parse(hex_data)

            # 判断是否成功
            success = result.get("code") == 200 or (
                result.get("code") == 500 and result.get("body_data")
            )

            status = "[PASS]" if success else "[FAIL]"

            print(f"{status} {name}")

            if success:
                results["passed"] += 1
                results["by_category"][category]["passed"] += 1
            else:
                results["failed"] += 1
                results["by_category"][category]["failed"] += 1

                # 打印错误信息
                if result.get("errors"):
                    for error in result.get("errors", []):
                        print(f"    错误: {error}")
                if result.get("warnings"):
                    for warning in result.get("warnings", []):
                        print(f"    警告: {warning}")
                # 打印原始结果用于调试
                if not result.get("errors") and not result.get("warnings"):
                    print(f"    调试: code={result.get('code')}, msg={result.get('msg')}")

        except Exception as e:
            print(f"[FAIL] {name}")
            print(f"    异常: {str(e)}")
            results["failed"] += 1
            results["by_category"][category]["failed"] += 1

    # 打印统计结果
    print(f"\n{'='*80}")
    print("测试统计")
    print(f"{'='*80}")
    print(f"总计: {results['total']} 个测试")
    print(f"通过: {results['passed']} 个")
    print(f"失败: {results['failed']} 个")
    print(f"成功率: {results['passed']/results['total']*100:.1f}%")

    print(f"\n按类别统计:")
    for category, stats in results["by_category"].items():
        total = stats["passed"] + stats["failed"]
        rate = stats["passed"] / total * 100 if total > 0 else 0
        print(f"  {category}: {stats['passed']}/{total} ({rate:.1f}%)")

    return results


if __name__ == '__main__':
    run_all_tests()
